<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScholarZone Dashboard</title>
    <link rel="stylesheet" href="../css/admin-dashboard.css">
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="logo">
            <img src="../pictures/scholarzone-logo.png" class="close1" id="close1">
            <span class="logo-text">
                <span class="logo-scholar">Scholar</span><span class="logo-zone">Zone</span>
            </span>
        </div>
        <div class="nav-item active">
            <a href="admin-dashboard.html" class="nav-link">
                <img src="../pictures/dashboard_icon.png" alt="Dashboard" class="nav-icon">
                Dashboard
            </a>
        </div>
        <div class="nav-item">
            <a href="admin-reviewer1.html" class="nav-link">
                <img src="../pictures/review_icon.png" alt="Review" class="nav-icon">
                Reviewers
            </a>
        </div>
        <div class="nav-item">
            <a href="admin-applications1.html" class="nav-link">
                <img src="../pictures/manage_icon.png" alt="Application" class="nav-icon">
                Applications
            </a>
        </div>
    </div>
    
    <div class="main-content">
        <div class="header">
            <div class="menu-toggle" id="menuToggle">â˜°</div>
            <div class="user-profile">
                <div class="username-container">
                    <span id="username">@admin</span>
                    <img src="../pictures/avatar-icon.png" alt="User" id="avatar-icon" class="avatar-icon" onclick="">
                    <img src="../pictures/bell-icon.png" alt="Bell" id="bell-icon" class="bell-icon" style="cursor: pointer;">
                    <div class="hover-profile" id="hover-profile">
                        <ul>
                            <li><a href="#" style="color: red;" onclick="logOut()">Log Out</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="name">
        <h1 class="overview-title">
            <img src="../pictures/dashboard_icon.png" alt="Dashboard" class="nav-icon">
            Overview
        </h1>
        </div>

        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="stat-number">
                    <img src="../pictures/tao_icon.png" alt="User" class="user-icon">
                    <span id="total-users">0</span>
                </div>
                <div class="stat-label">Total users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">
                    <img src="../pictures/black_icon.png" alt="User" class="user-icon">
                    <span id="pending-reviewers">0</span>
                </div>
                <div class="stat-label">Pending Reviewers</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">
                    <img src="../pictures/form_icon.png" alt="User" class="user-icon">
                    <span id="pending-applications">0</span>
                </div>
                <div class="stat-label">Pending Applications</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-title">Monthly Reviewer Signups</div>
                <div class="bar-chart-container">
                    <canvas id="timeChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        const AdminDashboardModel = {
            data: {
                totalUsers: 0,
                pendingReviewers: 0,
                pendingApplications: 0,
                chartData: [],
                isSidebarVisible: false
            },

            toggleSidebar() {
                this.data.isSidebarVisible = !this.data.isSidebarVisible;
                document.getElementById("sidebar").style.display = this.data.isSidebarVisible ? "block" : "none";
            },

            closeSidebar() {
                this.data.isSidebarVisible = false;
                document.getElementById("sidebar").style.display = "none";
            },

            logOut() {
                localStorage.clear();
                window.location.href = "admin-login.html";
            },

            async fetchDashboardData() {
                try {
                    let response = await fetch(`https://active-fox-exactly.ngrok-free.app/ScholarZone/api/admin-dashboard`, {
                        method: "GET",
                        headers: {
                            "ngrok-skip-browser-warning": "true"
                        }
                    });
                    let rawText = await response.text();
                    let data = JSON.parse(rawText);

                    if (data.status === 200) {
                        this.data.totalUsers = data.data.total_users;
                        this.data.pendingReviewers = data.data.pending_reviewers;
                        this.data.pendingApplications = data.data.pending_applications;
                    } else {
                        console.error("API Error:", data.message);
                    }
                } catch (error) {
                    console.error("Fetch Error:", error);
                }
            },
            
            async fetchChartData() {
                try {
                    let response = await fetch(`https://active-fox-exactly.ngrok-free.app/ScholarZone/api/monthly-signups`, {
                        method: "GET",
                        headers: { "ngrok-skip-browser-warning": "true" }
                    });

                    let rawText = await response.text();
                    let chartData;

                    try {
                        chartData = JSON.parse(rawText);
                        console.log("Parsed Chart API Response:", chartData);
                    } catch (jsonError) {
                        console.error("JSON Parsing Error. API returned HTML or invalid JSON:", jsonError);
                        return;
                    }

                    if (chartData.status === 200) {
                        this.data.chartData = chartData.data;
                    } else {
                        console.error("API returned error:", chartData.message);
                    }
                } catch (error) {
                    console.error("Fetch Request Failed:", error);
                }
            }
        };

        const AdminDashboardViewModel = {
            elements: {
                totalUsers: document.getElementById("total-users"),
                pendingReviewers: document.getElementById("pending-reviewers"),
                pendingApplications: document.getElementById("pending-applications"),
                timeCtx: document.getElementById("timeChart").getContext("2d"),
                sidebar: document.getElementById("sidebar"),
                menuToggle: document.getElementById("menuToggle"),
                closeBtn: document.getElementById("close1"),
                hoverProfile: document.getElementById("hover-profile"),
                avatarIcon: document.getElementById("avatar-icon"),
                bellIcon: document.getElementById("bell-icon")
            },

            async init() {
                const adminId = localStorage.getItem("adminId");
                if (!adminId) {
                    console.error("No ID found in localStorage.");
                    window.location.href = "admin-login.html";
                    return;
                }

                await AdminDashboardModel.fetchDashboardData();
                await AdminDashboardModel.fetchChartData();

                this.updateView();
                this.renderChart();
                this.bindEvents();
            },

            updateView() {
                this.elements.totalUsers.textContent = AdminDashboardModel.data.totalUsers;
                this.elements.pendingReviewers.textContent = AdminDashboardModel.data.pendingReviewers;
                this.elements.pendingApplications.textContent = AdminDashboardModel.data.pendingApplications;
                
                if (AdminDashboardModel.data.isSidebarVisible) {
                    this.elements.sidebar.classList.add("show");
                } else {
                    this.elements.sidebar.classList.remove("show");
                }
            },

            renderChart() {
                const chartDataArray = AdminDashboardModel.data.chartData;
                const labels = chartDataArray.map(item => item.month);
                const dataPoints = chartDataArray.map(item => item.total_signups);
                const ctx = this.elements.timeCtx;
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, "rgba(33,114,170,1)"); 
                gradient.addColorStop(1, "rgba(81,160,214,1)");

                new Chart(this.elements.timeCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Application Status Breakdown',
                            data: dataPoints,
                            backgroundColor: gradient,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 },
                                grid: { color: '#e5e7eb' }
                            },
                            x: {
                                grid: { display: false }
                            }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            },

            bindEvents() {
                if (this.elements.menuToggle) {
                    this.elements.menuToggle.addEventListener("click", () => {
                        AdminDashboardModel.toggleSidebar();
                        this.updateView();
                    });
                } else {
                    console.error("Element with ID 'menuToggle' not found.");
                }

                if (this.elements.closeBtn) {
                    this.elements.closeBtn.addEventListener("click", () => {
                        AdminDashboardModel.closeSidebar();
                        this.updateView();
                    });
                } else {
                    console.error("Element with ID 'close1' not found.");
                }

                const logOutLink = document.querySelector('a[onclick="logOut()"]');
                if (logOutLink) {
                    logOutLink.addEventListener("click", (event) => {
                        event.preventDefault();
                        const confirmLogOut = confirm("Are you sure you want to log out?");
                        if (confirmLogOut) {
                            AdminDashboardModel.logOut();
                        }
                    });
                } else {
                    console.error("Log Out link not found.");
                }

                if (this.elements.avatarIcon && this.elements.hoverProfile) {
                    this.elements.avatarIcon.addEventListener("click", (event) => {
                        this.elements.hoverProfile.classList.toggle("show");
                        event.stopPropagation();
                    });

                    document.addEventListener("click", (event) => {
                        if (
                            !this.elements.hoverProfile.contains(event.target) &&
                            event.target !== this.elements.avatarIcon
                        ) {
                            this.elements.hoverProfile.classList.remove("show");
                        }
                    });
                } else {
                    console.error("Avatar icon or hover profile element not found.");
                }

                if (this.elements.bellIcon) {
                    this.elements.bellIcon.addEventListener("click", () => {
                        window.location.href = 'admin-notifications.html';
                    });
                } else {
                    console.error("Bell icon element not found.");
                }
            }
    };

        document.addEventListener("DOMContentLoaded", () => {
            AdminDashboardViewModel.init();
        });
    </script>
</body> 
</html> 