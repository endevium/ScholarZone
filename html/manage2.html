<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScholarZone Manage</title>
    <link rel="stylesheet" href="../css/manage2.css">
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="logo">
            <img src="../pictures/scholarzone-logo.png" class="close1" id="close1">
            <span class="logo-text">
                <span class="logo-scholar">Scholar</span><span class="logo-zone">Zone</span>
            </span>
        </div>
        <div class="nav-item">
            <a href="dashboard.html" class="nav-link">
                <img src="../pictures/dashboard_icon.png" alt="Dashboard" class="nav-icon">
                Dashboard
            </a>
        </div>
        <div class="nav-item">
            <a href="create.html" class="nav-link">
                <img src="../pictures/create_icon.png" alt="Create" class="nav-icon">
                Create
            </a>
        </div>
        <div class="nav-item active">
            <a href="manage.html" class="nav-link">
                <img src="../pictures/manage_icon.png" alt="Manage" class="nav-icon">
                Manage
            </a>
        </div>
        <div class="nav-item">
            <a href="review.html" class="nav-link">
                <img src="../pictures/review_icon.png" alt="Review" class="nav-icon">
                Review
            </a>
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <div class="menu-toggle" id="menu-toggle">â˜°</div>
            <div class="user-profile">
                <div class="username-container">
                    <span id="username">@janedoe69</span>
                    <img src="../pictures/avatar-icon.png" alt="User" id="avatar-icon" class="avatar-icon" onclick="">
                    <img src="../pictures/bell-icon.png" alt="Bell" id="bell-icon" class="bell-icon">
                    <div class="hover-profile" id="hover-profile">
                        <ul>
                            <li><a href="settings.html">Edit Profile Picture</a></li>
                            <li><a href="personal-details.html">Personal Details</a></li>
                            <li><a href="account-details.html">Account Details</a></li>
                            <li><a href="landing.html" style="color: red;" onclick="logOut()">Log Out</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="name">
            <h1 class="create-title">
                <img src="../pictures/create_icon.png" alt="Dashboard" class="nav-icon">
                Edit
            </h1>
        </div>

        <div class="align-content">
            <div class="progress-bar">
                <div class="progress-step active"></div>
                <div class="progress-step"></div>
            </div>
        
        <form id="scholarship-application-form" class="create-form">
            <div class="form-container">
                <div class="left-section">
                    <div class="form-group">
                        <label for="formName">Application Form Name</label>
                        <input type="text" id="formName" placeholder="Create application form" required>
                    </div>
        
                    <div class="form-group">
                        <label for="formDescription">Application Form Description</label>
                        <textarea id="formDescription" placeholder="Describe your application form" rows="6" required></textarea>
                    </div>
        
                    <div class="form-group">
                        <label>Application Form Image</label>
                        <div class="upload-box" id="uploadbox">
                            <br>
                            <br>
                            <br>
                            <br>
                        </div>
                    </div>
                </div>
        
                <div class="right-section">
                    <div class="form-group2">
                        <label for="formDuration">Scholarship Duration</label>
                        <input type="text" id="formDuration" placeholder="Valid for 4 years" required>
                    </div>
        
                    <div class="form-group2">
                        <label for="category">Scholarship Category</label>
                        <select id="category" required>
                            <option value="Undergraduate">Undergraduate</option>
                            <option value="Graduate">Graduate</option>
                            <option value="STEM">STEM</option>
                            <option value="Arts">Arts</option>
                            <option value="Business">Business</option>
                            <option value="Education">Education</option>
                            <option value="Law">Law</option>
                            <option value="Medicine">Medicine</option>
                        </select>
                    </div>
        
                    <div class="form-group2">
                        <label for="availSlot">Available Slots</label>
                        <input type="number" id="availSlot" placeholder="100" required>
                    </div>
        
                    <div class="form-group2">
                        <label for="deadline">Deadline</label>
                        <input type="date" id="deadline" required>
                    </div>
                </div>
            </div>
    </div>

                <div class="form-actions">
                    <button type="submit" class="btn-next">Next</button>
                    <button type="reset" class="btn-reset">Reset</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async  function () {
            const storedId = localStorage.getItem("id");
            const avatarIcon = document.getElementById("avatar-icon");
            const hoverProfile = document.getElementById("hover-profile");
            const menuToggle = document.getElementById("menu-toggle");
            const sidebar = document.getElementById("sidebar");
            const closeBtn = document.getElementById("close1");
            const editApplicationForm = document.getElementById("scholarship-application-form");

            const application_name_input = document.getElementById("formName");
            const application_description_input = document.getElementById("formDescription");
            const application_duration_input = document.getElementById("formDuration");
            const application_category_input = document.getElementById("category");
            const application_slots_input = document.getElementById("availSlot");
            const application_deadline_input = document.getElementById("deadline");
            const application_name = localStorage.getItem("application_name");
            const uploadBox = document.getElementById("uploadbox");
            const application_image = localStorage.getItem("application_image");

            const company = localStorage.getItem("company");
            const application_description = localStorage.getItem("application_description");
            const duration = localStorage.getItem("duration");
            const slots = localStorage.getItem("slots");
            const deadline = localStorage.getItem("deadline");
            application_deadline_input.min = new Date().toISOString().split("T")[0];
            const bellBtn = document.getElementById("bell-icon");

            bellBtn.addEventListener("click", function () {
                window.location.href = "reviewer-notifications.html";
            });
            
            if (!storedId || storedId == 0) {
                console.error("No ID found in localStorage.");
                window.location.href = "login.html";
                return;
            }

            const logOutLink = document.querySelector('a[onclick="logOut()"]');
            if (logOutLink) {
                logOutLink.addEventListener("click", (event) => {
                    event.preventDefault();
                    const confirmLogOut = confirm("Are you sure you want to log out?");
                    if (confirmLogOut) {
                        localStorage.clear();
                        window.location.href = "login.html";
                    }
                });
            } else {
                console.error("Log Out link not found.");
            }          
            
            try {
                let response = await fetch(`https://active-fox-exactly.ngrok-free.app/ScholarZone/api/reviewers?id=${storedId}&ngrok-skip-browswer-warning=true`, {
                    method: "GET",
                    headers: {
                        "Content-type": "application/json",
                        "ngrok-skip-browser-warning": "true"
                    }
                });
            
                let rawText = await response.text();
                let data; 
                try {
                    data = JSON.parse(rawText);
                    console.log("Parsed API Response:", data);
                
                } catch (jsonError) {
                    console.error("JSON Parsing Error. API returned HTML or invalid JSON:", jsonError)
                    return;
                }
                if (data.status === 200){
                    const user = data.data;
                    console.log("User Data:", user);
            
                    const usernameElement = document.getElementById("username");
                    const profileIcon = document.getElementById("avatar-icon");

                    if (user.is_verified === "rejected") {
                            alert("Your account has been rejected. Please contact support.");
                            window.location.href = "login.html";
                            return;
                        }

                    if (usernameElement) {
                        usernameElement.textContent = "@" + user.username;
                        avatarIcon.src = user.profile_picture || "../pictures/avatar-icon.png";
                    } else {
                        console.error("Element with ID 'username' not found.");
                    }
                } else {
                    console.error("API returned error:", data.message);
                }
            
            } catch (error) {
                console.error("Fetch Request Failed:", error);
            }
    
            application_name_input.value = application_name;
            application_description_input.value = application_description;
            application_duration_input.value = duration;
            application_slots_input.value = slots;
            application_deadline_input.value = deadline;

            if (application_image) {
                uploadBox.style.backgroundImage = `url(${application_image})`;
                uploadBox.style.backgroundSize = "cover";
                uploadBox.style.backgroundPosition = "center";
            }
    
            avatarIcon.addEventListener("click", function (event) {
                hoverProfile.classList.toggle("show");
                event.stopPropagation();
            });
    
            menuToggle.addEventListener("click", function () {
                sidebar.classList.toggle("show");
            });
    
            closeBtn.addEventListener("click", function () {
                sidebar.classList.remove("show");
            });
    
            editApplicationForm.addEventListener("submit", async function (event) {
                event.preventDefault();
    
                const token = localStorage.getItem("token");
    
                    if (!token) {
                        alert("Authentication error: No token found.");
                        return;
                    }
    
                    const id = localStorage.getItem("scholarship_application_id");
    
                    let application_name = document.getElementById("formName").value;
                    let company = localStorage.getItem("company");
                    let application_description = document.getElementById("formDescription").value;
                    let duration = document.getElementById("formDuration").value;
                    let category = document.getElementById("category").value;
                    let slots = document.getElementById("availSlot").value;
                    let deadline = document.getElementById("deadline").value;
                    let application_image = localStorage.getItem("application_image");
        
                    try {
                        let response = await fetch("https://active-fox-exactly.ngrok-free.app/ScholarZone/api/scholarship-update", {
                        method: "PUT",
                        headers: {
                            "Content-type": "application/json",
                            "Authorization": `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            id: id,
                            application_name: application_name,
                            company: company,
                            application_description: application_description,
                            duration: duration,
                            category: category,
                            slots: slots,
                            deadline: deadline,
                            application_image: application_image
                        })
                    });
    
                        let data = await response.json();
    
                        if (data.status === 200) {
                            alert("Updated form successfully!");
                            window.location.href = "manage3.html";
                        } else {
                            alert(data.message);
                        }
                    } catch (error) {
                        console.error("Error:", error);
                        alert("Please check your internet connection");
                    }
            });
        });

        function updateImagePreview(input) {
            if (input.files && input.files[0]) {
                let reader = new FileReader();
                reader.onload = function (e) {
                    let uploadBox = document.getElementById("uploadbox");
                    uploadBox.style.backgroundImage = `url(${e.target.result})`;
                    uploadBox.style.backgroundSize = "cover";
                    uploadBox.style.backgroundPosition = "center";
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
    
        document.addEventListener("click", function (event) {
            if (!hoverProfile.contains(event.target) && event.target !== avatarIcon) {
                hoverProfile.classList.remove("show");
            }

            if (!sidebar.contains(event.target) && event.target !== menuToggle) {
                sidebar.classList.remove("show");
            }
        });
    </script>
</body>
</html>
