<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScholarZone Review</title>
    <link rel="stylesheet" href="../css/review3.css">
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="logo">
            <img src="../pictures/scholarzone-logo.png" class="close1" id="close1">
            <span class="logo-text">
                <span class="logo-scholar">Scholar</span><span class="logo-zone">Zone</span>
            </span>
        </div>
        <div class="nav-item">
            <a href="dashboard.html" class="nav-link">
                <img src="../pictures/dashboard_icon.png" alt="Dashboard" class="nav-icon">
                Dashboard
            </a>
        </div>
        <div class="nav-item">
            <a href="create.html" class="nav-link">
                <img src="../pictures/create_icon.png" alt="Create" class="nav-icon">
                Create
            </a>
        </div>
        <div class="nav-item">
            <a href="manage.html" class="nav-link">
                <img src="../pictures/manage_icon.png" alt="Manage" class="nav-icon">
                Manage
            </a>
        </div>
        <div class="nav-item active">
            <a href="review.html" class="nav-link">
                <img src="../pictures/review_icon.png" alt="Review" class="nav-icon">
                Review
            </a>
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <div class="menu-toggle" id="menu-toggle">â˜°</div>
            <div class="user-profile">
                <div class="username-container">
                    <span id="username">@janedoe69</span>
                    <img src="../pictures/avatar-icon.png" alt="User" id="avatar-icon" class="avatar-icon" onclick="">
                    <img src="../pictures/bell-icon.png" alt="Bell" id="bell-icon" class="bell-icon">
                    <div class="hover-profile" id="hover-profile">
                        <ul>
                            <li><a href="settings.html">Edit Profile Picture</a></li>
                            <li><a href="personal-details.html">Personal Details</a></li>
                            <li><a href="account-details.html">Account Details</a></li>
                            <li><a href="landing.html" style="color: red;">Log Out</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="name">
            <h1 class="create-title">
                <img src="../pictures/review_icon.png" alt="Dashboard" class="nav-icon">
                Review
            </h1>
        </div>

        <div class="align-content">
            <div class="back-button" >
                <img src="../pictures/backbtn-icon.png" id="back-button">
                <span id="back-button-text">Joe Mama's Application</span>
            </div>

            <div class="action-buttons">
                <button class="approved-btn" id="approve-button">Approve</button>
                <button class="rejected-btn" id="reject-button">Reject</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async  function () {
            const storedId = localStorage.getItem("id");
            const avatarIcon = document.getElementById("avatar-icon");
            const hoverProfile = document.getElementById("hover-profile");
            const menuToggle = document.getElementById("menu-toggle");
            const sidebar = document.getElementById("sidebar");
            const editButton = document.getElementById("edit");
            const backButton = document.getElementById("back-button");
            const backBtnText = document.getElementById("back-button-text");
            let token = localStorage.getItem("token");
            const bellBtn = document.getElementById("bell-icon");

            bellBtn.addEventListener("click", function () {
                window.location.href = "reviewer-notifications.html";
            });
    
            if (!storedId || storedId == 0) {
                console.error("No ID found in localStorage.");
                window.location.href = "login.html";
                return;
            }
            
            try {
                let response = await fetch(`https://active-fox-exactly.ngrok-free.app/ScholarZone/api/reviewers?id=${storedId}&ngrok-skip-browswer-warning=true`, {
                    method: "GET",
                    headers: {
                        "Content-type": "application/json",
                        "ngrok-skip-browser-warning": "true"
                    }
                });
            
                let rawText = await response.text();
                let data; 
                try {
                    data = JSON.parse(rawText);
                    console.log("Parsed API Response:", data);
                
                } catch (jsonError) {
                    console.error("JSON Parsing Error. API returned HTML or invalid JSON:", jsonError)
                    return;
                }
                if (data.status === 200){
                    const user = data.data;
                    console.log("User Data:", user);
            
                    const usernameElement = document.getElementById("username");
                    if (usernameElement) {
                        usernameElement.textContent = "@" + user.username;
                        
                    } else {
                            console.error("Element with ID 'username' not found.");
                    }
            
                } else {
                    console.error("API returned error:", data.message);
                }
            
            } catch (error) {
                console.error("Fetch Request Failed:", error);
            }
    
            avatarIcon.addEventListener("click", function (event) {
                hoverProfile.classList.toggle("show");
                event.stopPropagation();
            });
    
            menuToggle.addEventListener("click", function () {
                sidebar.classList.toggle("show");
            });
    
            const closeBtn = document.getElementById("close1");
            closeBtn.addEventListener("click", function () {
                sidebar.classList.remove("show");
            });
    
            document.addEventListener("click", function (event) {
                if (!hoverProfile.contains(event.target) && event.target !== avatarIcon) {
                    hoverProfile.classList.remove("show");
                }
    
                if (!sidebar.contains(event.target) && event.target !== menuToggle) {
                    sidebar.classList.remove("show");
                }
            });

            const questions = JSON.parse(localStorage.getItem("questions"));
            const alignContent = document.querySelector(".align-content");
            let applicantName = localStorage.getItem("applicant_name");
            backBtnText.textContent = `${applicantName}'s Application`;

            questions.forEach((question, index) => {
                const questionGroup = document.createElement("div");
                questionGroup.className = "question-group";

                const label = document.createElement("label");
                label.className = "question-label";
                label.setAttribute("for", `question${index}`);
                label.textContent = question.question;

                let input;

                if (question.type === "upload") {
                    input = document.createElement("input");
                    input.type = "text";
                    input.id = `question${index}`;
                    input.name = `question${index}`;
                    input.placeholder = "Type your answer here";
                    input.value = "Open File";
                    input.style = "color: blue;";
                    input.readOnly = true;
                    input.onclick = function () {
                        window.open(question.answer, '_blank');
                    }
                } else if (question.type === "question") {
                    input = document.createElement("input");
                    input.type = "text";
                    input.id = `question${index}`;
                    input.name = `question${index}`;
                    input.placeholder = "Type your answer here";
                    input.value = question.answer || "";
                    input.readOnly = true;
                }

                questionGroup.appendChild(label);
                questionGroup.appendChild(input);

                alignContent.insertBefore(questionGroup, alignContent.querySelector(".action-buttons"));
            });

            let applicationId = localStorage.getItem("application_id");

            const approveButton = document.getElementById("approve-button");
            const rejectButton = document.getElementById("reject-button");

            approveButton.addEventListener("click", async function () {
                try {
                    let response = await fetch("https://active-fox-exactly.ngrok-free.app/ScholarZone/api/update-status", {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                        body: JSON.stringify({ 
                            id: applicationId, 
                            status: "Approved"
                        })
                    });

                    let rawText = await response.text();
                    let data;
                    try {
                        data = JSON.parse(rawText);
                        console.log("Parsed API Response:", data);
                    } catch (jsonError) {
                        console.error("JSON Parsing Error. API returned HTML or invalid JSON:", jsonError);
                        return;
                    }

                    if (data.status === 200) {
                        alert("Application approved successfully");
                        window.location.href = "review2.html";
                    } else {
                        console.error("API returned error:", data.message);
                    }
                } catch (error) {
                    console.error("Fetch Request Failed:", error);
                }
            });

            rejectButton.addEventListener("click", async function () {
                try {
                    let response = await fetch("https://active-fox-exactly.ngrok-free.app/ScholarZone/api/update-status", {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                        body: JSON.stringify({ 
                            id: applicationId, 
                            status: "Rejected"
                        })
                    });

                    let rawText = await response.text();
                    let data;
                    try {
                        data = JSON.parse(rawText);
                        console.log("Parsed API Response:", data);
                    } catch (jsonError) {
                        console.error("JSON Parsing Error. API returned HTML or invalid JSON:", jsonError);
                        return;
                    }

                    if (data.status === 200) {
                        alert("Application rejected successfully");
                        window.location.href = "review2.html";
                    } else {
                        console.error("API returned error:", data.message);
                    }
                } catch (error) {
                    console.error("Fetch Request Failed:", error);
                }
            });
        }); 
    </script>
</body>
</html>